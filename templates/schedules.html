{% extends "base.html" %}

{% block content %}
<div x-data="{ showAddForm: false, deleteIndex: null }">
    <!-- Header -->
    <div class="mb-6">
        <div class="mb-4">
            <h2 class="text-2xl md:text-3xl font-bold text-white font-mono flex items-center flex-wrap">
                <i class="fas fa-calendar-alt text-purple-400 mr-3"></i>
                <span class="text-cyan-400">YOUTUBE</span> 
                <span class="ml-2">SCHEDULES</span>
            </h2>
            <p class="text-slate-400 text-sm mt-1">Manage automated YouTube livestream schedules</p>
        </div>
        <button @click="showAddForm = !showAddForm" 
                :class="showAddForm ? 'cyber-btn danger' : 'cyber-btn primary'"
                class="transition-all w-full sm:w-auto">
            <i :class="showAddForm ? 'fas fa-times' : 'fas fa-plus'" class="mr-2"></i>
            <span x-text="showAddForm ? 'Cancel' : 'Add New Schedule'"></span>
        </button>
    </div>

    <!-- Scheduler Configuration Section (All Users) -->
    <div class="glass-panel rounded-xl p-6 border border-cyan-500/20 mb-6" x-data="schedulerConfig()">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold text-white font-mono flex items-center">
                <i class="fas fa-robot text-cyan-400 mr-3"></i>
                AUTO <span class="text-purple-400 ml-2">SCHEDULER</span>
            </h3>
            <span class="{% if scheduler_status.active %}badge-cyber green animate-pulse{% else %}badge-cyber gray{% endif %}">
                {% if scheduler_status.active %}ACTIVE{% else %}INACTIVE{% endif %}
            </span>
        </div>
        
        <!-- Status Grid -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
            <div class="bg-slate-800/50 rounded-lg p-3 border border-slate-700/50">
                <div class="text-xs text-slate-400 mb-1 uppercase tracking-wider">Last Run</div>
                <div class="text-sm text-white font-mono">{{ scheduler_status.last_run or 'Never' }}</div>
            </div>
            <div class="bg-slate-800/50 rounded-lg p-3 border border-slate-700/50">
                <div class="text-xs text-slate-400 mb-1 uppercase tracking-wider">Next Check</div>
                <div class="text-sm text-cyan-400 font-mono">{{ scheduler_status.next_check or '-' }}</div>
            </div>
            <div class="bg-slate-800/50 rounded-lg p-3 border border-slate-700/50">
                <div class="text-xs text-slate-400 mb-1 uppercase tracking-wider">Last Status</div>
                <div class="text-sm {% if 'Error' in scheduler_status.last_status %}text-red-400{% else %}text-green-400{% endif %}">
                    {{ scheduler_status.last_status }}
                </div>
            </div>
            <div class="bg-slate-800/50 rounded-lg p-3 border border-slate-700/50">
                <div class="text-xs text-slate-400 mb-1 uppercase tracking-wider">My Schedule Times</div>
                <div class="text-sm text-white">{{ schedule_times|length }} time(s)</div>
            </div>
        </div>
        
        <!-- Schedule Times Configuration -->
        <div class="bg-slate-800/30 rounded-lg p-4 border border-slate-700/30 mb-4">
            <div class="flex items-center justify-between mb-3">
                <h4 class="text-sm font-bold text-slate-300 uppercase tracking-wider">
                    <i class="fas fa-clock mr-2"></i>My Schedule Times
                </h4>
                <button @click="addTime()" class="cyber-btn primary text-xs py-1 px-3">
                    <i class="fas fa-plus mr-1"></i>Add Time
                </button>
            </div>
            
            <form action="{{ url_for('update_schedule_times') }}" method="POST" id="schedulerForm">
                <div id="timesList" class="space-y-2 mb-3">
                    {% for time in schedule_times %}
                    <div class="flex items-center gap-2">
                        <input type="time" name="times[]" value="{{ time }}" required 
                               class="flex-1 cyber-input text-sm">
                        <button type="button" @click="removeTime($event.target)" 
                                class="cyber-btn danger text-xs py-2 px-3">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    {% endfor %}
                    {% if not schedule_times %}
                    <p class="text-slate-400 text-sm italic">No schedule times configured. Click "Add Time" to create one.</p>
                    {% endif %}
                </div>
                
                <button type="submit" class="cyber-btn success w-full">
                    <i class="fas fa-save mr-2"></i>
                    Save Schedule Times
                </button>
            </form>
        </div>
        
        <!-- Manual Control -->
        {% if is_admin %}
        <div class="flex gap-2">
            <form action="{{ url_for('run_scheduler') }}" method="POST" class="flex-1">
                <button type="submit" class="cyber-btn warning w-full">
                    <i class="fas fa-play mr-2"></i>
                    Run Scheduler Now (Admin)
                </button>
            </form>
        </div>
        {% endif %}
    </div>

    <!-- Add Schedule Form (Hidden by default) -->
    <div x-show="showAddForm" 
         x-collapse
         class="mb-6">
        <div class="cyber-card max-w-4xl w-full">
                <div class="cyber-border"></div>
                <div class="relative z-10 p-8">
                    <!-- Header -->
                    <div class="mb-6 pb-4 border-b border-cyan-500/20">
                        <h3 class="text-xl md:text-2xl font-bold text-white font-mono flex items-center">
                            <i class="fas fa-calendar-plus text-cyan-400 mr-3"></i>
                            ADD <span class="text-purple-400 ml-2">SCHEDULE</span>
                        </h3>
                        <p class="text-slate-400 text-sm mt-1">Create new YouTube livestream schedule</p>
                    </div>

                    <form action="{{ url_for('add_schedule') }}" method="POST" class="space-y-6">
                        <!-- Title -->
                        <div class="cyber-input-group">
                            <label class="cyber-label">
                                <i class="fas fa-heading mr-2"></i>Title
                            </label>
                            <input type="text" name="title" required class="cyber-input" placeholder="Enter schedule title...">
                        </div>

                        <!-- Description -->
                        <div class="cyber-input-group">
                            <label class="cyber-label">
                                <i class="fas fa-align-left mr-2"></i>Description
                            </label>
                            <textarea name="description" rows="3" class="cyber-input" placeholder="Enter description..."></textarea>
                        </div>

                        <!-- Scheduled Start Time -->
                        <div class="cyber-input-group">
                            <label class="cyber-label">
                                <i class="far fa-clock mr-2"></i>Scheduled Start Time
                            </label>
                            <input type="datetime-local" name="scheduledStartTime" required class="cyber-input">
                        </div>

                        <!-- Token & Privacy -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="cyber-input-group">
                                <label class="cyber-label">
                                    <i class="fas fa-key mr-2"></i>Token File
                                </label>
                                {% if tokens %}
                                <select name="tokenFile" id="tokenFileSelect_add" required class="cyber-input">
                                    {% for token in tokens %}
                                    <option value="{{ token }}">{{ token }}</option>
                                    {% endfor %}
                                </select>
                                {% else %}
                                <div class="bg-yellow-500/10 border border-yellow-500/30 p-3 rounded-lg">
                                    <p class="text-sm text-yellow-400">No tokens available. <a href="{{ url_for('tokens') }}" class="text-cyan-400 hover:text-cyan-300 underline">Create token</a></p>
                                </div>
                                {% endif %}
                            </div>
                            
                            <div class="cyber-input-group">
                                <label class="cyber-label">
                                    <i class="fas fa-lock mr-2"></i>Privacy Status
                                </label>
                                <select name="privacyStatus" class="cyber-input">
                                    <option value="unlisted">Unlisted</option>
                                    <option value="private">Private</option>
                                    <option value="public">Public</option>
                                </select>
                            </div>
                        </div>

                        <!-- Stream Settings -->
                        <div class="glass-panel p-4 rounded-lg border border-purple-500/20">
                            <h4 class="text-sm font-bold text-purple-400 mb-3 font-mono uppercase tracking-wider flex items-center">
                                <i class="fas fa-stream mr-2"></i>Stream Settings
                            </h4>
                            <div class="space-y-3">
                                <div class="flex items-center">
                                    <input type="checkbox" name="useExistingStream" id="useExistingStream_add"
                                           class="w-4 h-4 text-cyan-500 border-cyan-500/30 bg-dark-card rounded focus:ring-cyan-500">
                                    <label for="useExistingStream_add" class="ml-2 text-sm text-slate-300">Use Existing Stream</label>
                                </div>
                                
                                <div id="streamNameSection_add" style="display: none;" class="cyber-input-group">
                                    <label class="cyber-label">
                                        <i class="fas fa-video mr-2"></i>Stream
                                    </label>
                                    <select name="streamNameExisting" id="streamNameSelect_add" class="cyber-input">
                                        <option value="">Select a stream...</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Additional Settings -->
                        <div class="glass-panel p-4 rounded-lg border border-green-500/20">
                            <h4 class="text-sm font-bold text-green-400 mb-3 font-mono uppercase tracking-wider flex items-center">
                                <i class="fas fa-cog mr-2"></i>Additional Settings
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                                <div class="flex items-center">
                                    <input type="checkbox" name="autoStart" id="autoStart"
                                           class="w-4 h-4 text-green-500 border-green-500/30 bg-dark-card rounded focus:ring-green-500">
                                    <label for="autoStart" class="ml-2 text-sm text-slate-300">Auto Start</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" name="autoStop" id="autoStop"
                                           class="w-4 h-4 text-red-500 border-red-500/30 bg-dark-card rounded focus:ring-red-500">
                                    <label for="autoStop" class="ml-2 text-sm text-slate-300">Auto Stop</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" name="madeForKids" id="madeForKids"
                                           class="w-4 h-4 text-cyan-500 border-cyan-500/30 bg-dark-card rounded focus:ring-cyan-500">
                                    <label for="madeForKids" class="ml-2 text-sm text-slate-300">Made for Kids</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" name="repeat_daily" id="repeat_daily"
                                           class="w-4 h-4 text-purple-500 border-purple-500/30 bg-dark-card rounded focus:ring-purple-500">
                                    <label for="repeat_daily" class="ml-2 text-sm text-slate-300">Repeat Daily</label>
                                </div>
                            </div>
                            
                            <div class="cyber-input-group">
                                <label class="cyber-label">
                                    <i class="fas fa-image mr-2"></i>Thumbnail (Optional)
                                </label>
                                <select name="thumbnailFile" id="thumbnailSelect_add" class="cyber-input">
                                    <option value="">No thumbnail</option>
                                    {% for thumbnail in thumbnails %}
                                    <option value="{{ thumbnail.filename }}">{{ thumbnail.title }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div id="thumbnailPreview_add" style="display: none;" class="mt-3">
                                <label class="text-sm text-slate-400 mb-2 block">Preview</label>
                                <div class="flex justify-center">
                                    <img id="thumbnailPreviewImg_add" src="" class="max-h-48 rounded-lg border border-cyan-500/30">
                                </div>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="flex justify-end pt-4 border-t border-cyan-500/20">
                            <button type="submit" class="cyber-btn primary w-full sm:w-auto">
                                <i class="fas fa-plus mr-2"></i>Add Schedule
                            </button>
                        </div>
                    </form>
                </div>
            </div>
    </div>


    <!-- Schedules Grid -->
    {% if schedules and schedules|length > 0 %}
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for schedule in schedules %}
        <div class="schedule-card">
            <!-- Status Badge -->
            <div class="absolute top-4 right-4 z-10">
                {% if schedule.success %}
                <span class="status-badge completed">
                    <i class="fas fa-check"></i> SUCCESS
                </span>
                {% else %}
                <span class="status-badge scheduled">
                    <i class="far fa-clock"></i> PENDING
                </span>
                {% endif %}
            </div>

            <!-- Content -->
            <div class="p-6">
                <!-- Thumbnail -->
                {% if schedule.thumbnailFile %}
                <div class="mb-4">
                    <img src="{{ url_for('serve_thumbnail', filename=schedule.thumbnailFile) }}" 
                         alt="Thumbnail" 
                         class="w-full h-32 object-cover rounded-lg border border-cyan-500/30">
                </div>
                {% endif %}
                
                <h3 class="text-xl font-bold text-white mb-3 pr-24">{{ schedule.title }}</h3>
                
                <!-- Schedule Info -->
                <div class="space-y-2 mb-4">
                    <div class="flex items-center text-sm">
                        <i class="far fa-clock text-cyan-400 w-5 mr-2"></i>
                        <span class="text-slate-300 font-mono text-xs">{{ schedule.scheduledStartTime }}</span>
                    </div>
                    <div class="flex items-center text-sm">
                        <i class="fas fa-lock text-purple-400 w-5 mr-2"></i>
                        <span class="text-slate-300">{{ schedule.privacyStatus }}</span>
                    </div>
                    <div class="flex items-center text-sm">
                        <i class="fas fa-key text-yellow-400 w-5 mr-2"></i>
                        <span class="text-slate-300 truncate">{{ schedule.tokenFile }}</span>
                    </div>
                    {% if schedule.useExistingStream %}
                    <div class="flex items-center text-sm">
                        <i class="fas fa-stream text-green-400 w-5 mr-2"></i>
                        <span class="text-slate-300 truncate text-xs">{{ schedule.streamNameExisting or 'Existing Stream' }}</span>
                    </div>
                    {% endif %}
                </div>

                <!-- Badges -->
                <div class="flex flex-wrap gap-2 mb-4">
                    {% if schedule.autoStart %}
                    <span class="badge-cyber green">AUTO START</span>
                    {% endif %}
                    {% if schedule.autoStop %}
                    <span class="badge-cyber red">AUTO STOP</span>
                    {% endif %}
                    {% if schedule.madeForKids %}
                    <span class="badge-cyber cyan">KIDS</span>
                    {% endif %}
                    {% if schedule.repeat_daily %}
                    <span class="badge-cyber purple">REPEAT DAILY</span>
                    {% endif %}
                </div>

                <!-- Actions -->
                <div class="flex gap-2">
                    {% if schedule.broadcastLink %}
                    <a href="{{ schedule.broadcastLink }}" target="_blank" 
                       class="cyber-btn-sm primary flex-1">
                        <i class="fab fa-youtube mr-1"></i> View
                    </a>
                    {% endif %}
                    <a href="{{ url_for('edit_schedule', index=schedule.id) }}" 
                       class="cyber-btn-sm secondary">
                        <i class="fas fa-edit"></i>
                    </a>
                    <button @click="deleteIndex = {{ schedule.id }}"
                            class="cyber-btn-sm danger">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="cyber-card">
        <div class="cyber-border"></div>
        <div class="relative z-10 p-8 text-center">
            <i class="fas fa-calendar-alt text-5xl text-slate-600 mb-4"></i>
            <p class="text-slate-400 font-mono">Belum ada jadwal. Silakan tambahkan jadwal baru.</p>
        </div>
    </div>
    {% endif %}

    <!-- Delete Confirmation Modal - CYBER THEME -->
    <div x-show="deleteIndex !== null" 
         x-cloak
         class="fixed inset-0 z-50 overflow-y-auto"
         style="display: none;">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div @click="deleteIndex = null" class="fixed inset-0 bg-black/80 backdrop-blur-sm"></div>
            
            <div class="cyber-card max-w-md w-full relative z-10">
                <div class="cyber-border"></div>
                <div class="relative z-10 p-6">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 rounded-full bg-red-500/20 flex items-center justify-center mr-4">
                            <i class="fas fa-exclamation-triangle text-red-400 text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-white font-mono">CONFIRM DELETE</h3>
                            <p class="text-slate-400 text-sm">This action cannot be undone</p>
                        </div>
                    </div>
                    
                    <p class="text-slate-300 mb-6">
                        Are you sure you want to delete this schedule?
                    </p>
                    
                    <form method="POST" :action="`/delete_schedule/${deleteIndex}`" class="flex gap-3">
                        <button type="button" @click="deleteIndex = null" class="cyber-btn secondary flex-1">
                            <i class="fas fa-times mr-2"></i>Cancel
                        </button>
                        <button type="submit" class="cyber-btn danger flex-1">
                            <i class="fas fa-trash mr-2"></i>Delete
                        </button>
                    </form>
                </div>
            </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{% set sm_json = stream_mapping | tojson %}
<script>
const streamMapping_add = {{ sm_json | safe }} || {};

console.log('[SCHEDULES] Stream mapping loaded:', streamMapping_add);

// Stream management functions
function getAllStreams(mapping) {
    const allStreams = {};
    for (const [token, streams] of Object.entries(mapping)) {
        if (streams && typeof streams === 'object') {
            Object.entries(streams).forEach(([id, meta]) => {
                // Support both old format (meta.title) and new format (meta.stream_name)
                const streamTitle = meta && (meta.stream_name || meta.title);
                if (streamTitle) {
                    allStreams[id] = {
                        title: streamTitle,
                        token: token
                    };
                }
            });
        }
    }
    console.log('[SCHEDULES] All streams extracted:', allStreams);
    return allStreams;
}

function populateStreamSelect_Add() {
    const sel = document.getElementById('streamNameSelect_add');
    if (!sel) {
        console.error('[SCHEDULES] Stream select element not found');
        return;
    }
    
    sel.innerHTML = '';
    
    const emptyOpt = document.createElement('option');
    emptyOpt.value = '';
    emptyOpt.text = 'Select a stream...';
    sel.appendChild(emptyOpt);
    
    const allStreams = getAllStreams(streamMapping_add);
    const keys = Object.keys(allStreams);
    
    console.log('[SCHEDULES] Populating select with', keys.length, 'streams');
    
    if (keys.length === 0) {
        const noStreamOpt = document.createElement('option');
        noStreamOpt.value = '';
        noStreamOpt.text = 'No streams available';
        noStreamOpt.disabled = true;
        sel.appendChild(noStreamOpt);
        console.warn('[SCHEDULES] No streams found in mapping');
        return;
    }
    
    const entries = keys.map(sid => ({
        id: sid,
        name: allStreams[sid].title,
        token: allStreams[sid].token
    }));
    
    entries.sort((a, b) => a.name.localeCompare(b.name));
    
    for (const entry of entries) {
        const opt = document.createElement('option');
        opt.value = entry.id;
        opt.text = `${entry.name} (${entry.token})`;
        sel.appendChild(opt);
    }
    
    console.log('[SCHEDULES] Select populated successfully');
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    console.log('[SCHEDULES] DOM loaded, setting up event listeners');
    
    const useExistingCheckbox = document.getElementById('useExistingStream_add');
    if (useExistingCheckbox) {
        useExistingCheckbox.addEventListener('change', function() {
            const section = document.getElementById('streamNameSection_add');
            if (section) {
                section.style.display = this.checked ? 'block' : 'none';
                if (this.checked) {
                    console.log('[SCHEDULES] Use existing stream checked, populating select');
                    populateStreamSelect_Add();
                }
            }
        });
    }

    const thumbnailSelect = document.getElementById('thumbnailSelect_add');
    if (thumbnailSelect) {
        thumbnailSelect.addEventListener('change', function() {
            const filename = this.value;
            const previewContainer = document.getElementById('thumbnailPreview_add');
            const previewImg = document.getElementById('thumbnailPreviewImg_add');
            
            if (filename && previewContainer && previewImg) {
                previewImg.src = '/thumbnails/' + filename;
                previewContainer.style.display = 'block';
            } else if (previewContainer) {
                previewContainer.style.display = 'none';
            }
        });
    }
});

// Scheduler configuration management
function schedulerConfig() {
    return {
        addTime() {
            const timesList = document.getElementById('timesList');
            const newTimeDiv = document.createElement('div');
            newTimeDiv.className = 'flex items-center gap-2';
            newTimeDiv.innerHTML = `
                <input type="time" name="times[]" required class="flex-1 cyber-input text-sm">
                <button type="button" class="cyber-btn danger text-xs py-2 px-3">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            // Remove "no times" message if it exists
            const noTimesMsg = timesList.querySelector('p.italic');
            if (noTimesMsg) {
                noTimesMsg.remove();
            }
            
            timesList.appendChild(newTimeDiv);
            
            // Add event listener to the new remove button
            newTimeDiv.querySelector('button').addEventListener('click', (e) => {
                this.removeTime(e.target);
            });
        },
        
        removeTime(btn) {
            const timeDiv = btn.closest('div.flex');
            if (timeDiv) {
                timeDiv.remove();
                
                // If no times left, show message
                const timesList = document.getElementById('timesList');
                if (timesList.children.length === 0) {
                    timesList.innerHTML = '<p class="text-slate-400 text-sm italic">No schedule times configured. Click "Add Time" to create one.</p>';
                }
            }
        }
    };
}
</script>
{% endblock %}
